---
name: WebRTC权威指南学习笔记（3）
title: WebRTC权威指南学习笔记（3）
tags: ["技术","学习笔记","WebRTC权威指南"]
categories: 学习笔记
info: "第4章 信令"
time: 2021/4/12
desc: 'WebRTC权威指南, 资料下载, 学习笔记'
keywords: ['WebRTC权威指南', 'WebRTC', '学习笔记']
---

# WebRTC权威指南学习笔记（3）

## 第4章 信令

在 WebRTC 中，信令发挥着举足轻重的作用，但由于没有实现标准化，导致缺乏统一的标准，让人感到混乱。在实践中，开发者提出并使用了多种不同的信令方案，因此了解这些方案之间的差异，将有助于开发 WebRTC 应用程序时进行不同的选择。

### 4.1 信令的作用

信令的主要作用体现在四个方面：

1. 协商媒体功能和设置
2. 标识和验证会话参与者的身份
3. 控制媒体会话、指示进度、更改会话和终止会话
4. 当会话双方同时尝试建立或更改会话时，实施双占用分解（Glare Resolution）

#### 4.1.1 为何没有建立信令标准

在 WebRTC 中，之所以没有建立信令标准，是因为让两个浏览器能够进行互操作并不需要建立信令标准（...废话）。

实际上，信令是 Web 浏览器和 Web 服务器之间的一种事物，Web 服务器可确保两个浏览器通过下载的 JavaScript 代码来利用相同的信令协议。

![4-1.png](./images/4-1.png)

通过使用统一标准化信令协议，例如 SIP 或 Jingle，可以实现浏览器之间的互操作。

#### 4.1.2 媒体协商

WebRTC 规范包含针对“信令通道”的要求。信令最重要的功能在于，在参与对等连接的两个浏览器之间交换 SDP（Session Description Protocol，交换会话描述协议）对象。SDP 包含供浏览器中的 RTP 媒体栈配置媒体会话所需要的全部信息。

只有通过信令通道交换候选地址以后，才能进行 ICE 打洞（NAT 端口映射），因此如果没有信令功能，就无法建立对等连接。

### 4.2 信令传输

WebRTC 要求在两个浏览器之间建立双向信令通道。为此需要先来讨论信令消息的传输。

有三种方式用于传输 WebRTC 信令：HTTP、WebSocket 和数据通道。

#### 4.2.3 数据通道传输

数据通道的建立无法传输所有的 WebRTC 信令，但是，一旦建立了数据通道后，即可使用它来处理所有的信令。（翻译成人话就是：第一次数据通道的建立所使用的信令交换需要依托于 HTTP 或 WebSocket，但在建立了数据通道之后，就可以复用该通道来传输新的信令了）

![4-4.png](./images/4-4.png)

而由于第一次建立数据通道的信令负载要小得多，所以建立数据通道的信令也可以独立出来，单独做一个服务器来进行响应。

![4-5.png](./images/4-5.png)

### 4.3 信令协议

WebRTC 信令协议的选择至关重要，开发人员可选择创建自己的专有信令协议，或采用 SIP、Jingle 等标准信令协议，又或者使用通过抽象化处理剥离了信令协议细节的库。

#### 4.3.1 信令状态机

信令状态机中的每一种状态，并非都需要在两个浏览器之间交换同步消息，尽管某些信令方案会导致如此。

![4-6.png](./images/4-6.png)

采用标准信令协议的优点在于，已存在完全定义的状态机。此外，信令消息将包含有助于路由的信息。

采用专有信令（或称为自定义信令）的优点在于，它可以非常简单，如果 WebRTC 对等连接始终仅限于两个浏览器，而不通过中间环节或者不通向 SIP 或 Jingle VoIP 或是视频终端，则适合采取这一选项。

#### 4.3.2 信令标识

为了能够让信令**标识和验证会话参与者的身份（信令的第二项作用）**，需要在服务器中设置某种路由逻辑，让 Web 服务器在两个连接之间充当代理或用于转发信息。

有两个例子可用于说明该方案：

- 使用 WebSocket 代理
- 使用 Google 应用程序引擎通道 API

如果采用的是标准的信令协议，则可以仅需极少的配置就能通过标准服务器来提供此标识功能，例如采用 SIP 信令，可通过 SIP 代理服务器执行此功能。

#### 4.3.3 HTTP 轮询

使用 HTTP 来交换信令信息，就需要每个浏览器中运行的 JavaScript 通过轮询的方式向信令服务器发送 HTTP 消息，然后让 Web 服务器作为中间代理将这些消息发送给与这个浏览器进行对等连接的另一个浏览器。（当然也可以采用轮询方式）

![4-7.png](./images/4-7.png)

#### 4.3.4 WebSocket 代理

![4-8.png](./images/4-8.png)

WebSocket 建立代理的方式与 HTTP 轮询的原理类似，不过由于 WebSocket 是全双工的，所以这些消息的传递可以不用像 HTTP 那样统一由浏览器发起。

以下是一些建立 WebSocket 信令通道的伪代码片段：

![code-4-3-4.png](./images/code-4-3-4.png)

#### 4.3.5 Google 应用程序引擎通道 API

另一种常见但只适用于 Google 浏览器的方案是使用 Google 特有的引擎通道 API 作为信令通道。JavaScript 可以通过与 Google 的云服务器建立通道，使用 HTTP 长轮询（Google 将其称为 Comet 技术）技术将信息发送至客户端。所谓长轮询，就是让一个请求在一定时间内保持打开，直至服务器向客户端发送消息，才将该请求返回。

以下是实现的伪代码片段：

![code-4-3-5.png](./images/code-4-3-5.png)

#### 4.3.6 WebSocket SIP











> 本次阅读至 P54 WebSocket SIP 传输 73