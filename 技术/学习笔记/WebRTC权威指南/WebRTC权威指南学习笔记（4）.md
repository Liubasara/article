---
name: WebRTC权威指南学习笔记（4）
title: WebRTC权威指南学习笔记（4）
tags: ["技术","学习笔记","WebRTC权威指南"]
categories: 学习笔记
info: "第5章 对等媒体"
time: 2021/4/18
desc: 'WebRTC权威指南, 资料下载, 学习笔记'
keywords: ['WebRTC权威指南', 'WebRTC', '学习笔记']
---

# WebRTC权威指南学习笔记（4）

## 第 5 章 对等媒体

WebRTC 采用独特的对等媒体流，其中语音、视频和数据连接都直接在两个浏览器之间建立。

遗憾的是，由于存在网络地址转换（NAT）和防火墙，对等媒体流的实施难度大大增加，需要使用特殊的协议和过程才能实现。

本章介绍的 STUN 和 TURN 服务器可用于帮助建立对等媒体。

### 5.1 WebRTC 媒体流

本章讨论媒体流时，会使用如下几种浏览器来阐释相关概念。

![5-1.png](./images/5-1.png)

#### 5.1.1 不采用 WebRTC 时的媒体流

如果不使用 WebRTC 技术或插件，媒体流就必须与 Web 浏览通信遵循同一路径。换言之，媒体数据包将先从浏览器流向 Web 服务器再流向另一端的浏览器，这种情况下，高清视频流回占用大量带宽。这就限制了该体系结构的可扩展性。

![5-2.png](./images/5-2.png)

#### 5.1.2 采用 WebRTC 时的媒体流

![5-3.png](./images/5-3.png)

使用 WebRTC 中的 RTCPeerConnection API 帮助在浏览器之间建立对等媒体连接，可大幅降低提供实时通信服务的成本。

### 5.2 WebRTC 和网络地址转换

NAT 功能通常内置在 Internet 路由器或集线器中，用于将一个 IP 地址空间映射到另一个空间，现实世界里，其实大多浏览器都位于 NAT 之后。

NAT 功能通常内置于路由器或集线器中，用于将一个 IP 地址空间映射到另一个空间，对于 WebRTC 服务这种采用端对端或对等设计的协议和服务，就会遭到巨大的困难。

#### 5.2.1 通过多个 NAT 的对等媒体流

采用打洞技术，媒体流可以绕过 Web 服务器，直接通过多个 NAT 在两个浏览器之间流动。

![5-5.png](./images/5-5.png)

#### 5.2.2 通过通用 NAT 的对等媒体流

![5-6.png](./images/5-6.png)

位于同一 NAT 之后的两个浏览器之间建立媒体会话的情形下，最佳的媒体路径是保持在局域网之内，而不越入 Internet。与上一种形式一样，这同样需要打洞技术才能实现媒体流。

#### 5.2.3 私有地址和公共地址

NAT 技术普遍使用“私有地址”和“公共地址”两个术语。位于 NAT 内部的 IP 地址是私有 IP 地址，分配给 NAT 的 IP 地址的是公共 IP 地址。NAT 每次从内部向外转发数据包时，都使用公共地址。

![5-7.png](./images/5-7.png)

私有 IP 地址并没有任何特殊的隐私保护特性或功能，而只是约定俗成的规矩，它们拥有特定的 IP 地址范围（192.168.x.x、10.x.x.x、172.16.x.x -- 172.31.x.x），任何人都可以在自己的网络中使用。

NAT 负责维护私有 IP 地址和端口号与外部 IP 地址和端口号之间的映射表，除此之外，还负责维护过滤器规则，规定公共 Internet 中的哪些 IP 地址和端口号可以使用这些已创建的映射。

### 5.3 STUN 服务器

STUN 是一种帮助遍历 NAT 的服务器（第 10 章介绍），全称为 NAT 会话遍历实用工具（Session Traversal Utilities for NAT，STUN）。

![5-8.png](./images/5-8.png)

每个浏览器通过发送 STUN 数据包来查询 STUN 服务器，STUN 服务器会指示其在测试数据包中监测到的 IP 地址。换言之，它使用 NAT 映射的地址做出响应。对于从 STUN 服务器获取的这一 IP 地址，将与另一端的浏览器所共享。

### 5.4 TURN 服务器

TURN 服务器也称为中继型 NAT 遍历服务器（Travesal Using Relay around NAT，TURN，第 10 章介绍）。浏览器通过查询 TURN 服务器来获取媒体的中继地址。中继地址是一个公共 IP 地址，用于转发从浏览器收到的数据包，或者将收到的数据包转发给浏览器。如果两个对等端之间单纯因为 NAT 的类型而无法建立直接的对等媒体会话，则可以使用中继地址。虽然这种媒体流并不理想，但至少不会占用 Web 服务器的带宽。

![5-9.png](./images/5-9.png)

### 5.5 候选项

打洞技术（第 9 章介绍）依靠将要建立的会话中的每个对等端来收集一组可通过 Internet 访问它们的潜在方式。这些 IP 地址和端口组被称为“地址候选项”，简称“候选项”。

借助 STUN 服务器，浏览器可以识别自己是否位于 NAT 之后以及该 NAT 的 IP 地址（此地址称为“反射候选项”）。

而利用 TURN 服务器，浏览器可以获取中继地址，该地址称为“中继候选项”。在 JavaScript 中，这些候选项包含在 RTCIceCandidates 对象的 candidate 属性中。

用于实现打洞的协议称为交互式连接建立（Interactive Connectivity Establishment ICE）协议（详见地 9 章）。

## 第 6 章 对等连接和提议/应答协商







> 本次阅读至 P96 第 6 章 对等连接和提议/应答协商 115