---
name: WebRTC权威指南学习笔记（8）
title: WebRTC权威指南学习笔记（8）
tags: ["技术","学习笔记","WebRTC权威指南"]
categories: 学习笔记
info: "第9章 NAT和防火墙穿透 第10章 协议"
time: 2021/5/9
desc: 'WebRTC权威指南, 资料下载, 学习笔记'
keywords: ['WebRTC权威指南', 'WebRTC', '学习笔记']
---

# WebRTC权威指南学习笔记（8）

## 第9章 NAT和防火墙穿透

WebRTC 采用独特的端到端媒体流，但由于存在网络地址转换（Network Address Translation，NAT）和防火墙增加了这一技术的实施难度，需要采用特殊的协议和过程才能实现。

### 9.1 穿透简介

通过利用一种名为“穿透”（BRYAN）的技术，可以大概率建立到端对端的对话，平均成功率大概高达 85%。采用穿透技术需要满足多项前提条件，这些条件包括：

1. 尝试建立直接连接的两个浏览器必须同时发送“穿透”数据包。因此二者必须都知道将要建立的会话，以及将要将数据包发送到哪个地址。请注意穿透数据包没有任何特殊之处，发送这些数据包的目的是确定是否可以通过 NAT 访问特定的目标地址。
2. 两个浏览器需要尽可能多地获知可用于访问对方的潜在 IP 地址。
3. 需要一个具有公共 IP 地址（即不位于 NAT 之后）并因此可由两个浏览器访问的媒体中继，用作万不得已时的访问途径
4. 必须采用端对端流，换言之，即便是 UDP 通信展现出来的行为必须类似于 TCP 连接

其中的要求 2 可以通过使用 NAT 会话遍历实用工具（Session Traversal Utilities for NAT，STUN）服务器来满足。当然也可以使用其他 NAT 遍历协议，例如 UPnP 协议，不过并不常见。

要求 3 可通过使用中继型 NAT 遍历服务器（TURN）来满足。媒体中继地址是一个公共 IP 地址，用于转发从设置中继地址的浏览器收到的数据包。此地址随后会被添加到候选项列表中。

通过让浏览器使用其用来侦听传入媒体的同一 UDP 端口发送媒体，可以满足要求 4，使 NAT 将 UDP 上的两个 RTP 会话识别为一个双向 RTP 会话。

#### 通过 TURN 服务器提供中继的媒体

某些无法建立直接路径的情况下，只有通过 TURN 服务器的地址才能成功。在实际情况下，TURN 服务器是增加了中继功能的 STUN 服务器，在许多情况下，二者是一体的。所有 TURN 服务器都同时具备 STUN 功能，但并非每台 STUN 服务器都具有 TURN 功能。

### 9.2 交互式连接建立

交互式连接建立（Interactive Connectivity Establishment，ICE）是一种标准穿透协议，利用 STUN 和 TURN 服务器来帮助端点建立连接。

下面将分别介绍建立穿透连接时的各个步骤。

#### 9.2.1 收集候选传输地址

首先第一步是收集候选地址，候选地址是或许可用于接收媒体以建立对等连接的 IP 地址和端口。在许多情况下，这些地址必须在呼叫时收集，而不能提前收集（个人理解这是因为 NAT 映射会随时改变）。

一旦 A 处的用户发起与 B 建立对等连接的请求，ICE 代理 A 就会开始收集候选地址，而一旦接受到从信令通道中传来的对等连接请求，ICE 代理 B 也会开始收集候选地址。

![9-1.png](./images/9-1.png)

候选地址分为四种地址，如下表所示：

![table-9-1.png](./images/table-9-1.png)

其中，服务器反射候选项 和 对等反射候选项 又被称为“反射地址”，因为它们表示**由 STUN 检查反射回 ICE 代理的地址，就如同客户端在通过 STUN 服务器照镜子，以此来识别自身的实际 IP 地址**。

对于在这一步骤中使用的 STUN 和 TURN 服务器，需要在浏览器中进行相应的配置，具体来说，就是通过 RTCConfiguration 对象的 iceServers 属性中的 STUN URI 和 TURN URI 进行实现。

需要指出的是，仅仅使用 STUN 识别公共 IP 地址候选项本身并不足以遍历 NAT，NAT 非常复杂，而且不同的网络和服务提供商存在很大的差异。因此，需要完整的 ICE 功能才能确保实现 NAT 遍历。

#### 9.2.2 交换候选项

第二步就是通过信令通道交换候选地址，一般而言，主机候选项的优先级最高，其次是反射地址，最后是中继候选项。候选项与 SDP 中的一个特定媒体流相关联，WebRTC 的默认行为是通过同一传输地址对所有媒体进行多路传输，包括语音、视频和数据，因此只需要一组候选项即可。

#### 9.2.3 STUN 连接检查

一旦 ICE 代理发送并收到了候选项，就会开始进行连接检查。此步骤可以发现对等反射候选地址，存在五种可能的连接状态：

![9-2.png](./images/9-2.png)

#### 9.2.4 选择选定的对并启动媒体

连接检查将一直持续，直至所有候选项可能的配对检查都已完成，或者某一对候选项被选中。然后，两个浏览器即可使用所选的 候选项对 发送媒体

#### 9.2.5 长连接

为确保 NAT 映射和过滤规则不在媒体会话期间超时，ICE 会不断通过使用中的 候选项对 发送连接检查，每隔 15 秒发送一次，确保数据包得到持续发送。

#### 9.2.6 ICE 重新启动

无论任何一端的 ICE 代理检测到传输基地址发生了更改，都会重新触发 ICE 的事件。基地址 是用于生成正在使用的候选项对的传输地址。该事件会导致 ICE 代理重新执行步骤 1 来收集候选项，再以 SDP offer 提议的形式将这些候选项发送给另一端的 ICE 代理。

### 9.3 WebRTC 和防火墙

防火墙用于在网络边界上强制实施安全策略，并执行任何类型的 IP 数据包过滤或拦截。就本质而言，其作用就是允许网络内部发起的正常 IP 通信，但拦截来自 Internet 的恶意通信。

#### WebRTC 防火墙遍历

用于遍历 NAT 的打洞技术通常也适用于遍历防火墙，某些防火墙设有更为严格的规则，会导致穿透失败。目前有许多不同的方法用于帮助当今的 VoIP 和视频通信遍历防火墙，一种是在防火墙中内置识别 VoIP 信令和媒体协议的功能，以便防火墙在媒体会话期间为媒体开通“针孔”。但这种方法不适用于 WebRTC，因为 WebRTC 没有使用标准化的信令协议。

另一种方法是采用防火墙信任的专用 VoIP 和视频防火墙。

![9-3.png](./images/9-3.png)

## 第 10 章 协议

以下是与 WebRTC 相关的一些重要协议：

![table-10-1.png](./images/table-10-1.png)

### 10.1 协议

一般情况下，Web 开发人员不会直接与协议交互，因为协议的默认设置和配置通常就可以满足他们的需要。但是在某些情况下——尤其是在 WebRTC 客户端与非 WebRTC 客户端进行通信时，就需要在一定程度上了解和配置 WebRTC 使用的协议。

此外，如果需要调整 WebRTC API 中的 RTCSessionDescription 对象（例如当用户代理之间存在 SDP 互操作性问题时，可能就需要如此），开发人员就需要深入了解协商的工作机制了。

![10-1.png](./images/10-1.png)

### 10.2 WebRTC 协议概述

#### 10.2.1 HTTP 协议

WebRTC 使用 HTTP 的方式与其他 Web 应用程序一样。

#### 10.2.2 WebSocket 协议









> 本地阅读至 P161 10.2.2 WebSocket 协议 180