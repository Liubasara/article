---
name: 《Linux命令行》学习笔记（十四）
title: 《Linux命令行》学习笔记（十四）
tags: ["技术","学习笔记","Linux命令行与shell脚本编程大全"]
categories: 学习笔记
info: "第16章 控制脚本"
time: 2020/6/16
desc: 'Linux命令行与shell脚本编程大全, 资料下载, 学习笔记, 第16章 控制脚本'
keywords: ['Linux命令行与shell脚本编程大全', 'shell学习', '学习笔记', '第16章 控制脚本']
---

# 《Linux命令行》学习笔记（十四）

## 第16章 控制脚本

> 本章内容：
>
> - 处理信号
> - 以后台模式运行脚本
> - 禁止挂起
> - 作业控制
> - 修改脚本优先级
> - 脚本执行自动

### 16.1 处理信号

Linux 可以利用信号与运行在系统中的进程进行通信。可以通过对脚本进行编程，使其在收到特定信号时执行某些命令从而控制 shell 脚本的操作。

#### 16.1.1 重温 Linux 信号

Linux 有以下信号。在脚本中捕获时要在其名称前加上 SIG 前缀。

![linux-signal-1.jpg](./images/linux-signal-1.jpg)

默认情况下，bash shell 会忽略收到的 SIGQUIT（3）信号和 SIGTERM（15）信号，而会处理收到的 SIGHUP（1）信号和 SIGINT（2）信号。

> 通过SIGINT信号，可以中断shell。Linux内核会停止为shell分配CPU处理时间。这种情况发生时，shell会将SIGINT信号传给所有由它所启动的进程，以此告知出现的状况。
>
> 而shell脚本的默认行为 是忽略这些信号。它们可能会不利于脚本的运行。要避免这种情况，你可以脚本中加入识别信号的代码，并执行命令来处理信号

#### 16.1.2 生成信号

bash shell 可以使用 Ctrl 键和键盘上的某些特定按键生成两种基本的 Linux 信号。

**1. 中断进程**

Ctrl+C 组合键会发送 INT（2） 信号，停止 shell 中当前运行的进程。比如`sleep`命令会使得 shell 暂停指定的秒数，而在此之前按下 Ctrl+C 组合键，就可以提前终止进程。

**2. 暂停进程**

你可以使用 Ctrl+Z 组合键发送一个 TSTP（18） 信号，使其在进程运行期间暂停进程而无需终止它。尽管有时这样会比较危险，但它可以让你在不终止进程的情况下使你能够深入脚本内部一窥究竟。

输入 Ctrl+Z 之后，shell 会通知进程已停止。

```shell
sleep 100
# ^Z
# [1]+  已停止               sleep 100
```

方括号中的数字是 shell 分配的作业号，它会将第一个作业分配给作业号 1，第二个作业号 2，以此类推。

如果你的 shell 会话中已有一个已停止的作业，在退出 shell 时，bash 会提醒你有登出的任务。

```shell
exit
# 登出
# 有停止的任务。
```

当然如果你已经知道了已停止作业的 PID，就可以用`kill`命令来发送一个 KILL 信号来终止它。

```shell
kill -9 PID
# [1]+  Killed                  sleep 100
```

shell 会显示一条消息，说明作业在运行时被终止了。

#### 16.1.3 捕获信号

> 也可以不忽略信号，在信号出现时捕获它们并执行其他命令。

`trap`命令允许你来指定 shell 脚本并从 shell 中拦截的 Linux 信号。该命令的格式是：`trap commands signals`

```shell
#!/bin/bash
trap "echo '拦截 Ctrl+C 操作'" SIGINT
echo 测试脚本
count=1
while [ $count -le 10 ]
do
	echo "Loop #$count"
	sleep 1
	count=$[ $count + 1 ]
done
echo "脚本结束"
```

如上面的脚本，`trap`命令会在每次检测到信号时显示一行文本消息，同时阻止用户停止程序，而不是处理该信号并允许shell 停止该脚本。

#### 16.1.4 捕获脚本退出

shell 脚本中不仅可以捕获系统信号，还可以捕获 EXIT 信号。当脚本运行到正常的退出位置时，就会触发 EXIT 信号，而如果提前退出也同样能够捕获到。

```shell
#!/bin/bash
trap "echo byebye" EXIT
echo "执行"
```

> 当按下 Ctrl+C 组合键发送 SIGINT 信号时，脚本也会退出。但在脚本退出前捕获到了EXIT，于是 shell 也会执行 trap 命令

#### 16.1.5 修改或移除捕获

要想在脚本中的不同位置进行不同的捕获处理，只需重新使用带有新选项的 trap 命令。

也就是说，当触发信号时，程序会在已经执行过的程序中自动寻找最后一次出现的 trap 命令以触发。

```shell
trap "echo 无效trap" EXIT
trap "echo 有效trap" EXIT
echo "hi~"
```

也可以删除已设置好的捕获，只需要在`trap`命令与希望恢复默认行为的信号列表之间加个破折号就行了。

```shell
trap "echo 'wow, you can really dance'" EXIT
# 删除捕获
trap - EXIT
echo "测试~"
```

### 16.2 以后台模式运行脚本

> 以后台模式运行shell脚本非常简单。只要在命令后加个&符就行了

```shell
./test.sh &
```

当 & 符放到命令后时，它会将命令和 bash shell 分离开，并将命令作为系统中的一个独立后台进程运行。

注意当后台进程运行时，它仍然会使用显示器来显示 STDERR 和 STDOUT 的消息。

要避免后台的命令和自己要做的事情输出混在一起这种情况，最好还是在脚本中做好进行重定向。

#### 16.2.3 在非控制台下运行脚本

使用`nohup`命令可以让脚本一直以后台模式运行到结束。

`nohup`命令会阻断所有发送给该进程的 SIGHUP 信号，也能够在退出终端时阻止进程退出。

```shell
nohup ./test.sh &
```

> 由于 nohup 命令会解除终端与进程的关联，进程也就不再同 STDOUT 和 STDERR 联系在一起。 
>
> 如果使用 nohup 运行了另一个命令，该命令的输出会被追加到已有的 nohup.out 文件中。当 运行位于同一个目录中的多个命令时一定要当心，因为所有的输出都会被发送到同一个 nohup.out 文件中，结果会让人摸不清头脑。

nohup.out 文件通常包含了所有发送到终端显示器上的输出。

### 16.4 作业控制

> 启动、停止、终止以及恢复作业的这些功能统称为作业控制。通过作业控制，就能完全控制 shell 环境中所有进程的运行方式了

使用 CTRL+Z 停止正在运行的作业后，你可以选择用`kill`命令终止该进程，如果要重启则需要向其发送一个 SIGCONT 信号。

#### 16.4.1 查看作业









> 阅读至 P342 357