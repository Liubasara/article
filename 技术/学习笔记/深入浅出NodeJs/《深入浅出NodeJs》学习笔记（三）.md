---
name: 《深入浅出NodeJs》学习笔记（三）
title: 《深入浅出NodeJs》学习笔记（三）
tags: ['读书笔记', '深入浅出NodeJs']
categories: 学习笔记
info: "深入浅出NodeJs 第3章 异步IO"
time: 2019/5/12
desc: '深入浅出NodeJs, 资料下载, 学习笔记, 第3章 异步IO'
keywords: ['深入浅出NodeJs资料下载', '前端', '深入浅出NodeJs', '学习笔记', '第3章 异步IO']
---

# 《深入浅出NodeJs》学习笔记（三）

## 第3章 异步I/O

> “异步”这个名词其实很早就诞生了，但它的大规
> 模流行却是在Web 2.0浪潮中，它伴随着AJAX的第一个A（Asynchronous）席卷了Web。 Node在出现之前，最习惯异步编程的程序员莫过于前端工程师了。前端编程算GUI编程的一种，其中充斥了各种Ajax和事件，这些都是典型的异步应用场景。 
>
> 但事实上，异步早就存在于操作系统的底层。在底层系统中，异步通过信号量、消息等方式有了广泛的应用。意外的是，在绝大多数高级编程语言中，异步并不多见，疑似被屏蔽了一般。
> 造成这个现象的主要原因也许令人惊讶：程序员不太适合通过异步来进行程序设计。
> PHP这门语言的设计最能体现这个观点。它对调用层不仅屏蔽了异步，甚至连多线程都不提供。 PHP语言从头到脚都是以同步阻塞的方式来执行的。它的优点十分明显，利于程序员顺序编写业务逻辑；它的缺点在小规模站点中基本不存在，但是在复杂的网络应用中，阻塞导致它无法更好地并发。 (PS: **这就是PHP天下第一的原因!**)
>
> 伴随着异步I/O的还有事件驱动和单线程，它们构成Node的基调， Ryan Dahl正是基于这几个因素设计了Node。 Ryan Dahl最初期望设计出一个高性能的Web服务器，后来则演变为一个可以基于它构建各种高速、可伸缩网络应用的平台，因为一个Web服务器已经无法完全涵盖和代表它的能力了。尽管它不再是一个服务器，但是可以基于它搭建更多更丰富、更强大的网络应用。
> 与Node的事件驱动、异步I/O设计理念比较相近的一个知名产品为Nginx。Nginx采用纯C编写，性能表现非常优异。它们的区别在于， Nginx具备面向客户端管理连接的强大能力，但是它的背后依然受限于各种同步方式的编程语言。但Node却是全方位的，既可以作为服务器端去处理客户端带来的大量并发请求，也能作为客户端向网络中的各个应用进行并发请求。 

### 3.1 为什么要异步IO

在跨网络的结构下，并发已经是现代编程中的标准配备了。具体到实处，可以从用户体验和资源分配这两个方面说起。

#### 3.1.1 用户体验

> 《高性能JavaScript》一书中曾经总结过，如果脚本的执行时间超过100毫秒，用户就会感到页面卡顿，以为网页停止响应。而在B/S模型中，网络速度的限制给网页的实时体验造成很大的麻烦。

前段通过异步可以消除掉 UI 阻塞的现象，但是前端获取资源的速度也取决于后端的响应速度。采用异步方式可以让我们享受到并发的优势，这就是异步 IO 在 Node 中如此盛行，甚至将其作为主要理念进行设计的原因。IO 是昂贵的，分布式 IO 是更昂贵的。

只有后端能够快速响应资源，才能让前端的体验变好。

#### 3.1.2 资源分配

> 排除用户体验的因素，我们从资源分配的层面来分析一下异步I/O的必要性。我们知道计算机在发展过程中将组件进行了抽象，分为I/O设备和计算设备。
> 假设业务场景中有一组互不相关的任务需要完成，现行的主流方法有以下两种：
>
> - 单线程串行依次执行
> - 多线程并行完成
>
> 如果创建多线程的开销小于并行执行，那么多线程的方式是首选的。多线程的代价在于创建线程和执行期线程上下文切换的开销较大。另外，在复杂的业务中，多线程编程经常面临锁、状态同步等问题，这是多线程被诟病的主要原因。但是多线程在多核CPU上能够有效提升CPU的利用率，这个优势是毋庸置疑的。

**单线程同步编程模型会因阻塞I/O导致硬件资源得不到更优的使用。多线程编程模型也因为编程中的死锁、状态同步等问题让开发人员头疼**。

 Node 对此给出的方案是：利用单线程、远离多线程死锁、状态同步等问题；利用异步 IO ，让单线程远离阻塞，以更好地使用 CPU。

Node 是首个大规模将异步 IO 应用在应用层上的平台，力求在单线程将资源分配地更高效。同时为了弥补单线程无法利用多核 CPU 的缺点，Node 提供了类似前端浏览器中 Web Workers 的子进程，该子进程可以通过工作进程高效地利用 CPU 和 IO。

### 3.2 异步 IO 实现现状

异步 IO 在 Node 中应用最为广泛，但它并非 Node 的原创。

#### 3.2.1 异步 IO 与非阻塞 IO

> 在听到Node的介绍时，我们时常会听到异步、非阻塞、回调、事件这些词语混合在一起推介出来，其中异步与非阻塞听起来似乎是同一回事。从实际效果而言，异步和非阻塞都达到了我们并行I/O的目的。但是从计算机内核I/O而言，异步/同步和阻塞/非阻塞实际上是两回事。 



> 本次阅读至 P50 3.2.1 异步IO与非阻塞IO 68